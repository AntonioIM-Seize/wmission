module.exports=[44066,a=>{"use strict";async function b(a,c,d={}){let e=function(a){if(!a)return null;try{let b=new URL(a).pathname.split("/").filter(Boolean),c=b.findIndex(a=>"public"===a);if(-1===c)return null;let d=decodeURIComponent(b[c+1]??""),e=b.slice(c+2).map(a=>decodeURIComponent(a)).join("/");if(!d||!e)return null;return{bucket:d,path:e}}catch(a){return console.error("공개 스토리지 URL 파싱 실패",a),null}}(c);if(!e)return;let f=d.expectedBucket??"content-images";if(f&&e.bucket!==f)return;let{error:g}=await a.storage.from(e.bucket).remove([e.path]);g&&console.error("스토리지 객체 삭제 실패",g)}a.s(["removePublicStorageFile",()=>b])},93695,(a,b,c)=>{b.exports=a.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},62212,a=>{a.n(a.i(66114))},65893,a=>{a.n(a.i(68852))},11388,a=>{"use strict";function b(a,b){var c="error";let d=JSON.stringify({level:c,message:a,meta:function(a){if(a)return JSON.parse(JSON.stringify(a,(a,b)=>b instanceof Error?{name:b.name,message:b.message,stack:b.stack}:b))}(b),timestamp:new Date().toISOString(),environment:"production"});switch(c){case"error":console.error(d);break;case"warn":console.warn(d);break;default:console.info(d)}}a.s(["logError",()=>b])},80455,(a,b,c)=>{b.exports=a.x("jsdom",()=>require("jsdom"))},86703,a=>{"use strict";function b(a){return a.replace(/[%_]/g,a=>`\\${a}`)}a.s(["escapeIlikePattern",()=>b])},44839,a=>{"use strict";function b(a,b){return a?a.length<=b?a:`${a.slice(0,b).trimEnd()}…`:""}function c(a){return a?a.replace(/[#*_>`~\[\]\(\)]/g,""):""}function d(a){return a?a.replace(/<[^>]*>/g,""):""}a.s(["stripHtml",()=>d,"stripMarkdown",()=>c,"truncateText",()=>b])},78137,a=>{"use strict";a.s(["getDevotionAdminMetrics",()=>j,"getDevotionById",()=>h,"getDevotionMonthlySummary",()=>k,"getDevotionsList",()=>g,"incrementDevotionViewCount",()=>i]);var b=a.i(98310),c=a.i(51860),d=a.i(86703),e=a.i(44839),f=a.i(11388);async function g(a){let{page:c,pageSize:g}=a,h=await (0,b.createSupabaseServerClient)(),i=a.filters??{};a.search&&!i.search&&(i.search=a.search);let j=(c-1)*g,k=h.from("devotions").select(`
        id,
        title,
        scripture_ref,
        body,
        image_url,
        published_at,
        views,
        author:profiles!devotions_author_id_fkey (
          id,
          full_name,
          status,
          role
        )
      `,{count:"exact"}).order("published_at",{ascending:!1}).range(j,j+g-1);if(i.startDate&&(k=k.gte("published_at",i.startDate)),i.endDate&&(k=k.lte("published_at",i.endDate)),"with"===i.hasImage?k=k.not("image_url","is",null):"without"===i.hasImage&&(k=k.is("image_url",null)),i.search){let a=`%${(0,d.escapeIlikePattern)(i.search)}%`;k=k.or(`title.ilike.${a},scripture_ref.ilike.${a}`)}let{data:l,error:m,count:n}=await k;if(m)return(0,f.logError)("묵상 목록 조회 실패",{error:m}),{items:[],total:0,page:c,pageSize:g};let o=l?.map(a=>{let b=a.body??"";return{id:a.id,title:a.title,scriptureRef:a.scripture_ref,imageUrl:a.image_url??null,excerpt:(0,e.truncateText)((0,e.stripMarkdown)(b),180),publishedAt:a.published_at,authorName:a.author?.full_name??"익명",views:a.views??0}})??[];return{items:o,total:n??o.length,page:c,pageSize:g}}async function h(a){let d=await (0,b.createSupabaseServerClient)(),{data:e,error:g}=await d.from("devotions").select(`
        id,
        title,
        scripture_ref,
        scripture_text,
        body,
        image_url,
        published_at,
        views,
        author:profiles!devotions_author_id_fkey (
          id,
          full_name,
          role,
          status
        )
      `).eq("id",a).maybeSingle();return g?((0,f.logError)("묵상 상세 조회 실패",{error:g,devotionId:a}),null):e?{id:e.id,title:e.title,scriptureRef:e.scripture_ref,scriptureText:e.scripture_text??"",body:(0,c.sanitizeHTML)(e.body??""),publishedAt:e.published_at,views:e.views,authorId:e.author?.id??"",authorName:e.author?.full_name??"익명",authorRole:e.author?.role??"member",authorStatus:e.author?.status??"approved",imageUrl:e.image_url??null}:null}async function i(a){let c=await (0,b.createSupabaseServerClient)(),{error:d}=await c.rpc("increment_devotion_views",{devotion_id:a});d&&(0,f.logError)("묵상 조회수 증가 실패",{error:d,devotionId:a})}async function j(){let a=await (0,b.createSupabaseServerClient)(),c=new Date(new Date);c.setDate(c.getDate()-30);let[d,e,g,h]=await Promise.all([a.from("devotions").select("id",{count:"exact",head:!0}),a.from("devotions").select("id",{count:"exact",head:!0}).gte("published_at",c.toISOString()),a.from("devotions").select("id",{count:"exact",head:!0}).not("image_url","is",null),a.from("devotions").select("id, title, views, published_at, author_id")]);d.error&&(0,f.logError)("묵상 총합 조회 실패",{error:d.error}),e.error&&(0,f.logError)("묵상 최근 30일 조회 실패",{error:e.error}),g.error&&(0,f.logError)("이미지 포함 묵상 수 조회 실패",{error:g.error}),h.error&&(0,f.logError)("묵상 메트릭 세부 조회 실패",{error:h.error});let i=h.data??[],j=i.reduce((a,b)=>a+(b.views??0),0),k=new Set(i.map(a=>a.author_id).filter(Boolean)).size,l=i.filter(a=>"number"==typeof a.views).sort((a,b)=>(b.views??0)-(a.views??0))[0]??null;return{total:d.count??i.length,last30Days:e.count??0,withImage:g.count??0,totalViews:j,uniqueAuthors:k,topDevotion:l?{id:l.id,title:l.title,views:l.views??0,publishedAt:l.published_at}:null}}async function k(a=6){let c=await (0,b.createSupabaseServerClient)(),d=new Date;d.setMonth(d.getMonth()-(a-1)),d.setDate(1);let{data:e,error:g}=await c.from("devotions").select("published_at, views").gte("published_at",d.toISOString()).order("published_at",{ascending:!1});if(g)return(0,f.logError)("묵상 월간 요약 조회 실패",{error:g}),[];let h=new Map;return e?.forEach(a=>{if(!a.published_at)return;let b=new Date(a.published_at);if(Number.isNaN(b.getTime()))return;let c=b.getFullYear(),d=String(b.getMonth()+1).padStart(2,"0"),e=`${c}-${d}`,f=`${c}년 ${d}월`,g=h.get(e)??{label:f,count:0,views:0};g.count+=1,g.views+=a.views??0,h.set(e,g)}),Array.from(h.entries()).map(([a,b])=>({monthKey:a,label:b.label,count:b.count,views:b.views})).sort((a,b)=>a.monthKey<b.monthKey?1:-1).slice(0,a)}},13047,a=>{a.n(a.i(67304))},4404,a=>{a.n(a.i(13348))},55046,a=>{"use strict";a.s(["devotionCreateSchema",()=>c,"devotionUpdateSchema",()=>d]);var b=a.i(83111);let c=b.z.object({title:b.z.string().min(3,"제목은 최소 3자 이상 입력해주세요."),scriptureRef:b.z.string().min(2,"성경 구절을 입력해주세요."),scriptureText:b.z.string().min(5,"구절 내용을 입력해주세요."),body:b.z.string().min(50,"묵상 내용은 최소 50자 이상 작성해주세요."),imageUrl:b.z.string().url("올바른 이미지 주소가 아닙니다.").optional().or(b.z.literal("").transform(()=>void 0))}),d=c.extend({id:b.z.string().uuid()})},42642,a=>{"use strict";a.s(["deleteDevotionAction",()=>l,"updateDevotionAction",()=>m]);var b=a.i(37936),c=a.i(18558);a.i(70396);var d=a.i(73727),e=a.i(98310),f=a.i(51860),g=a.i(53058),h=a.i(63250),i=a.i(55046),j=a.i(44066),k=a.i(11388);async function l(a){let b=a.get("devotionId");if(!b||"string"!=typeof b)throw Error("잘못된 요청입니다.");let f=await (0,g.getCurrentProfile)();f||(0,d.redirect)("/login?redirectTo=/devotion");let i=await (0,e.createSupabaseServerClient)(),{data:l,error:m}=await i.from("devotions").select("id, author_id, image_url").eq("id",b).maybeSingle();if(m)throw(0,k.logError)("묵상 조회 실패",{error:m,devotionId:b}),Error("삭제할 묵상을 찾지 못했습니다.");if(!l)throw Error("이미 삭제되었거나 존재하지 않는 묵상입니다.");if(l.author_id!==f.id&&!(0,h.isAdmin)(f.role))throw Error("삭제 권한이 없습니다.");let{error:n}=await i.from("devotions").delete().eq("id",b);if(n)throw(0,k.logError)("묵상 삭제 실패",{error:n,devotionId:b}),Error("묵상을 삭제하지 못했습니다. 잠시 후 다시 시도해주세요.");l.image_url&&await (0,j.removePublicStorageFile)(i,l.image_url),(0,c.revalidatePath)("/devotion"),(0,d.redirect)("/devotion")}async function m(a){let b=await (0,g.getCurrentProfile)();b||(0,d.redirect)("/login");let l=i.devotionUpdateSchema.safeParse(a);if(!l.success)return{status:"error",message:"입력값을 확인해주세요.",fieldErrors:l.error.flatten().fieldErrors};let m=await (0,e.createSupabaseServerClient)(),{data:n,error:o}=await m.from("devotions").select("author_id, image_url").eq("id",l.data.id).maybeSingle();if(o||!n)return(0,k.logError)("묵상 조회 실패",{error:o,devotionId:l.data.id}),{status:"error",message:"묵상을 찾지 못했습니다."};if(n.author_id!==b.id&&!(0,h.isAdmin)(b.role))return{status:"error",message:"수정 권한이 없습니다."};let p=l.data.imageUrl?l.data.imageUrl.trim():null,{error:q}=await m.from("devotions").update({title:l.data.title.trim(),scripture_ref:l.data.scriptureRef.trim(),scripture_text:(0,f.sanitizeHTML)(l.data.scriptureText),body:(0,f.sanitizeHTML)(l.data.body),image_url:p}).eq("id",l.data.id);if(q)return(0,k.logError)("묵상 업데이트 실패",{error:q,devotionId:l.data.id}),{status:"error",message:"묵상을 수정하지 못했습니다. 잠시 후 다시 시도해주세요."};n.image_url&&n.image_url!==p&&await (0,j.removePublicStorageFile)(m,n.image_url),(0,c.revalidatePath)("/devotion"),(0,c.revalidatePath)(`/devotion/${l.data.id}`),(0,d.redirect)(`/devotion/${l.data.id}`)}(0,a.i(13095).ensureServerEntryExports)([l,m]),(0,b.registerServerReference)(l,"406365968578a9e391e6fd30dfa39723ca2cbf9405",null),(0,b.registerServerReference)(m,"4060930bc37c927ba46773326a9cf52a31cf762c4e",null)},73200,a=>{a.n(a.i(4202))},3822,a=>{"use strict";a.s(["006e87d2ba50d7749061e0234a2c5ee819ab969621",()=>d.signOutAction,"4060930bc37c927ba46773326a9cf52a31cf762c4e",()=>e.updateDevotionAction],3822),a.s([],15632);var b=a.i(42998),c=a.i(42642);a.i(15632);var d=b,e=c},23520,a=>{"use strict";a.s(["DevotionEditForm",()=>b]);let b=(0,a.i(11857).registerClientReference)(function(){throw Error("Attempted to call DevotionEditForm() from the server but DevotionEditForm is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/components/forms/devotion-edit-form.tsx <module evaluation>","DevotionEditForm")},16785,a=>{"use strict";a.s(["DevotionEditForm",()=>b]);let b=(0,a.i(11857).registerClientReference)(function(){throw Error("Attempted to call DevotionEditForm() from the server but DevotionEditForm is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/components/forms/devotion-edit-form.tsx","DevotionEditForm")},69906,a=>{"use strict";a.i(23520);var b=a.i(16785);a.n(b)},21884,a=>{"use strict";a.s(["default",()=>h]);var b=a.i(7997);a.i(70396);var c=a.i(73727),d=a.i(69906),e=a.i(78137),f=a.i(53058),g=a.i(63250);async function h({params:a}){let h=await (0,f.getCurrentProfile)();h||(0,c.redirect)(`/login?redirectTo=/devotion/${a.id}/edit`);let i=await (0,e.getDevotionById)(a.id);i||(0,c.notFound)(),i.authorId===h.id||(0,g.isAdmin)(h.role)||(0,c.redirect)(`/devotion/${a.id}`);let j={id:i.id,title:i.title,scriptureRef:i.scriptureRef,scriptureText:i.scriptureText,body:i.body,imageUrl:i.imageUrl??""};return(0,b.jsx)(d.DevotionEditForm,{initialValues:j})}}];

//# sourceMappingURL=%5Broot-of-the-server%5D__6fc33cc3._.js.map